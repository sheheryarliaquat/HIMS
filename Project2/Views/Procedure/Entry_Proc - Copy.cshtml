@model Project2.Models.TBL_MPROC_DETAIL

@{
    ViewBag.Title = "Procedure Entry";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="form-horizontal">
        <form id="form">

            @Html.ValidationSummary(true, "", new { @class = "text-danger" })

            <div class="row">
                <div class="col-md-5">
                    <div class="card">
                        <div class="card-header card-header-primary">
                            <h4 class="card-title"> Patient Information</h4>
                            <p class="card-category">Complete your profile</p>
                        </div>
                        <div class="card-body">

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.MR_NO, htmlAttributes: new { @class = "bmd-label-floating" })
                                        @Html.EditorFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.MR_NO, new { htmlAttributes = new { @class = "form-control", id = "MR" } })
                                        @Html.ValidationMessageFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.MR_NO, "", new { @class = "text-danger" })
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.TEL_NO, htmlAttributes: new { @class = "bmd-label-floating" })
                                        @Html.EditorFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.TEL_NO, new { htmlAttributes = new { @class = "form-control", id = "telNo" } })
                                        @Html.ValidationMessageFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.TEL_NO, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#myModal" id="search"><i class="fa fa-search"></i> Search</button>
                                    </div>
                                </div>
                            </div>
                            <div class="row">

                                <div class="col-md-12">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.FIRST_NAME, htmlAttributes: new { @class = "bmd-label-floating" })
                                        @Html.EditorFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.FIRST_NAME, new { htmlAttributes = new { @class = "form-control", id = "name" } })
                                        @Html.ValidationMessageFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.FIRST_NAME, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            </div>
                            <div class="row">

                                <div class="col-md-12">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.F_NAME, htmlAttributes: new { @class = "bmd-label-floating" })
                                        @Html.EditorFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.F_NAME, new { htmlAttributes = new { @class = "form-control", id = "fname" } })
                                        @Html.ValidationMessageFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.F_NAME, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            </div>
                            <div class="row">

                                <div class="col-md-4">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.AGE, htmlAttributes: new { @class = "bmd-label-floating" })
                                        @Html.EditorFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.AGE, new { htmlAttributes = new { @class = "form-control", id = "age" } })
                                        @Html.ValidationMessageFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.AGE, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.DATEOFBIRTH, htmlAttributes: new { @class = "bmd-label-floating" })
                                        @Html.EditorFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.DATEOFBIRTH, new { htmlAttributes = new { @class = "form-control", id = "dob" } })
                                        @Html.ValidationMessageFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.DATEOFBIRTH, "", new { @class = "text-danger" })
                                    </div>
                                </div>

                            </div>
                            <div class="row">

                                <div class="col-md-4">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.GENDER, htmlAttributes: new { @class = "bmd-label-floating" })
                                        @Html.DropDownListFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.GENDER, ViewBag.gendr as SelectList, "..Select Gender..", new { @class = "form-control", id = "gender" })
                                        @Html.ValidationMessageFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.GENDER, "", new { @class = "text-danger" })

                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.CNIC_NO, htmlAttributes: new { @class = "bmd-label-floating" })
                                        @Html.EditorFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.CNIC_NO, new { htmlAttributes = new { @class = "form-control", id = "nic" } })
                                        @Html.ValidationMessageFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.CNIC_NO, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            </div>
                            @*<div class="row">

                        <div class="col-md-12">
                            <div class="form-group">
                                @Html.LabelFor(model => model.TBL_R_PATIENT.AGE, htmlAttributes: new { @class = "bmd-label-floating" })
                                @Html.EditorFor(model => model.TBL_R_PATIENT.AGE, new { htmlAttributes = new { @class = "form-control" } })
                                @Html.ValidationMessageFor(model => model.TBL_R_PATIENT.AGE, "", new { @class = "text-danger" })
                            </div>
                        </div>
                    </div>*@
                            <div class="row">

                                <div class="col-md-12">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.ADDRESS1, htmlAttributes: new { @class = "bmd-label-floating" })
                                        @Html.EditorFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.ADDRESS1, new { htmlAttributes = new { @class = "form-control", id = "address" } })
                                        @Html.ValidationMessageFor(model => model.TBL_MASTER_PROCEDURE.TBL_R_PATIENT.ADDRESS1, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card">
                        <div class="card-header card-header-primary">
                            <h4 class="card-title"> Procedure Order</h4>
                            <h4 class="card-title"> Procedure Order</h4>
                            <p class="card-category">Complete your profile</p>
                            <p class="card-category">Complete your profile</p>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.TBL_MASTER_PROCEDURE.MR, htmlAttributes: new { @class = "bmd-label-floating" })
                                        @Html.EditorFor(model => model.TBL_MASTER_PROCEDURE.MR, new { htmlAttributes = new { @class = "form-control", id = "MR" } })
                                        @Html.ValidationMessageFor(model => model.TBL_MASTER_PROCEDURE.MR, "", new { @class = "text-danger" })
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.TBL_MASTER_PROCEDURE.MP_CONS, htmlAttributes: new { @class = "bmd-label-floating" })
                                        @Html.EditorFor(model => model.TBL_MASTER_PROCEDURE.MP_CONS, new { htmlAttributes = new { @class = "form-control", id = "telNo" } })
                                        @Html.ValidationMessageFor(model => model.TBL_MASTER_PROCEDURE.MP_CONS, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.TBL_MASTER_PROCEDURE.MP_CONS, htmlAttributes: new { @class = "bmd-label-floating" })
                                        @Html.EditorFor(model => model.TBL_MASTER_PROCEDURE.MP_CONS, new { htmlAttributes = new { @class = "form-control", id = "telNo" } })
                                        @Html.ValidationMessageFor(model => model.TBL_MASTER_PROCEDURE.MP_CONS, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <table id="tblCustomers" class="table" cellpadding="0" cellspacing="0" width="300px">
                                    <thead>
                                        <tr>
                                            <th >Pro ID</th>
                                            <th>Pro Name</th>
                                            <th >Pro Price</th>
                                            <th >Pro Quantiity</th>
                                            <th >Amount</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @*@foreach (var customer in Model)
                    {
                        <tr>
                            <td>@customer.DEPT_ID</td>
                            <td>@customer.DEPT_NAME</td>
                            <td><input type="button" value="Remove" onclick="Remove(this)" /></td>
                        </tr>
                    }*@
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td><input type="text" id="pro_code"  /></td>
                                            <td>
                                                <input type="text" id="pro_name" />
                                            </td>
                                            <td><input type="text" id="pro_cat"  /></td>
                                            <td><input type="text" id="pro_price" /></td>
                                            <td><input type="text" id="pro_amount"  /></td>


                                            <td><input type="button" id="btnAdd" value="Add" /></td>
                                        </tr>
                                    </tfoot>
                                </table>

                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.TBL_MASTER_PROCEDURE.MR, htmlAttributes: new { @class = "bmd-label-floating" })
                                        @Html.EditorFor(model => model.TBL_MASTER_PROCEDURE.MR, new { htmlAttributes = new { @class = "form-control", id = "MR" } })
                                        @Html.ValidationMessageFor(model => model.TBL_MASTER_PROCEDURE.MR, "", new { @class = "text-danger" })
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.TBL_MASTER_PROCEDURE.MP_CONS, htmlAttributes: new { @class = "bmd-label-floating" })
                                        @Html.EditorFor(model => model.TBL_MASTER_PROCEDURE.MP_CONS, new { htmlAttributes = new { @class = "form-control", id = "telNo" } })
                                        @Html.ValidationMessageFor(model => model.TBL_MASTER_PROCEDURE.MP_CONS, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <button type="button" class="btn btn-danger" id="btnSave"><i class="fa fa-search"></i> Search</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>


            </div>
            <div id="myModal" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <!-- Modal content-->
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Modal Header</h4>
                        </div>
                        <div class="modal-body">
                            <select class="Country" style="width:400px" multiple>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal" id="save">Confirm</button>
                        </div>
                    </div>

                </div>
            </div>

        </form>
    </div>
}

<script src="~/Scripts/jquery.unobtrusive-ajax.min.js"></script>
<script src="~/Scripts/jquery-3.4.1.min.js"></script>
<script>
    $(document).ready(function ()
    {
        $(".Country").select2({
                placeholder: "Conatact Number ",
                theme: "classic",
                ajax:
                {

                    url: '/Home/PatientData',
                    dataType: 'json',
                    data: function (params)
                    {
                        return {
                            searchTerm: params.term
                        };
                    },
                    processResults: function (data, params) {
                        return {
                            results: data
                        };
                    }
                }
            });
        $("#dept").change(function ()
            {
                 var dp = $("#dept").val();

                $.ajax({
                    url: "/Home/GetConsultant?DEP=" + dp,
                    method: "POST",
                    datatype: "json",
                    success: function (data)
                    {
                        var s = '<option value="-1">Select a Department</option>';
                   for (var i = 0; i < data.length; i++) {
                       s += '<option value="' + data[i].Id + '">' + data[i].Name + '</option>';
                   }
                   $("#cons").html(s);
                    },
                    error: function (err) { console.error(err) }
                });

            });
        $("#cons").change(function ()
                  {
                      console.log("1");
                    var fee = $("#cons").val();
                $.ajax({
                    url: "/Home/GetConsultantFee?con=" + fee,
                    method: "POST",
                    datatype: "json",
                    success: function (data)
                    {
                        console.log(data);

                        var s = '<option value="-1">Select a Consultant</option>';
                   for (var i = 0; i < data.length; i++) {
                       s += '<option value="' + data[i].fee + '">' + data[i].fee + '</option>';
                   }
                   $("#FEE").html(s);
                    },
                    error: function (err) { console.error(err) }
                });
        });
        $("#age").change(function ()
        {
            var ag = $('#age').val();
            var date = new Date();
           $("#dob").val((date.getMonth()) + '/' + (date.getDate() ) + '/' + (date.getFullYear() -ag));
        });
        $("#MR").change(function ()
        {

            var mr = $("#MR").val();

            $.ajax({
                url: "/Home/getDatapatient?MRNO=" + mr,
                method: "POST",
                datatype: "json",
                success: function (data)
                {
                    var data = JSON.parse(data);
                    alert(data);
                    $(".FFname").text(data[0].Name);
                    document.getElementById("name").value = (data[0].name);
                    document.getElementById("fname").value = (data[0].fname);
                    document.getElementById("telNo").value = (data[0].telno);
                    document.getElementById("gn").value = (data[0].gn);
                    document.getElementById("nic").value = (data[0].nic);
                    document.getElementById("dob").value = (data[0].dob);
                    $(".telNo").text(data.Name);
                },
                error: function (err) { console.error(err) }
            });

        });

    });
         $("#save").click(function ()
            {

                var mr = $(".Country").val();
                $.ajax({
                    url: "/Home/getDatapatient?MRNO=" + mr,
                    method: "POST",
                    datatype: "json",
                    success: function (data)
                    {

                        //var data = JSON.parse(data);
                        console.log(data);
                        //$(".FFname").text(data[0].Name);
                        document.getElementById("name").value = (data[0].name);
                        document.getElementById("fname").value = (data[0].fname);
                        document.getElementById("telNo").value = (data[0].telno);

                        document.getElementById("gn").value = (data[0].gn);
                        document.getElementById("nic").value = (data[0].nic);
                        document.getElementById("dob").value = (data[0].dob);

                        //$(".telNo").text(data.Name);
                    },
                    error: function (err) { console.error(err) }
                })
            });
         $("#search").click(function ()
            {
                 document.getElementById("name").value = "";
                        document.getElementById("fname").value = "";
                        document.getElementById("telNo").value = "";
                        document.getElementById("dob").value = "";
                        document.getElementById("gn").value = "";
                 document.getElementById("nic").value = "";

         });
    $("#MR").change(function ()
        {

            var mr = $("#MR").val();

            $.ajax({
                url: "/Home/getDatapatient?MRNO=" + mr,
                method: "POST",
                datatype: "json",
                success: function (data)
                {
                    //alert("1");
                    //var data = JSON.parse(data);
                    //$(".FFname").text(data[0].Name);
                    document.getElementById("MR").value = (data[0].id);
                    document.getElementById("name").value = (data[0].name);
                    document.getElementById("fname").value = (data[0].fname);
                    document.getElementById("telNo").value = (data[0].telno);
                    document.getElementById("nic").value = (data[0].nic);
                    document.getElementById("dob").value = (data[0].dob);
                    document.getElementById("age").value = (data[0].age);
                    document.getElementById("gn").value = (data[0].gn);
                    $(".telNo").text(data.Name);
                },
                error: function (err) { console.error(err) }
            });

        });
    $("body").on("click", "#btnAdd", function () {
        //Reference the Name and Country TextBoxes.
        var pro_code = $("#pro_code");
        var pro_name = $("#pro_name");
        var pro_cat = $("#pro_cat");
        var pro_price = $("#pro_price");
        var pro_amount = $("#pro_amount");

        //Get the reference of the Table's TBODY element.
        var tBody = $("#tblCustomers > TBODY")[0];

        //Add Row.
        var row = tBody.insertRow(-1);

        //Add Name cell.
        var cell = $(row.insertCell(-1));
        cell.html(pro_code.val());

        //Add Country cell.
        cell = $(row.insertCell(-1));
        cell.html(pro_name.val());


        cell = $(row.insertCell(-1));
        cell.html(pro_cat.val());
        cell = $(row.insertCell(-1));
        cell.html(pro_price.val());
          cell = $(row.insertCell(-1));
        cell.html(pro_amount.val());
        //Add Button cell.
        cell = $(row.insertCell(-1));
        var btnRemove = $("<input />");
        btnRemove.attr("type", "button");
        btnRemove.attr("onclick", "Remove(this);");
        btnRemove.val("Remove");
        cell.append(btnRemove);

        //Clear the TextBoxes.
        pro_code.val("");
        pro_name.val("");
        pro_cat.val("");
        pro_price.val("");
        pro_amount.val("");
    });

    function Remove(button) {
        //Determine the reference of the Row using the Button.
        var row = $(button).closest("TR");
        var name = $("TD", row).eq(0).html();
        if (confirm("Do you want to delete: " + name))
        {
            //Get the reference of the Table.
            var table = $("#tblCustomers")[0];

            //Delete the Table row using it's Index.
            table.deleteRow(row[0].rowIndex);
        }
    };

    $("body").on("click", "#btnSave", function ()
    {
        alert("1");
        //Loop through the Table rows and build a JSON array.
        var customers = new Array();
        $("#tblCustomers TBODY TR").each(function () {
            var row = $(this);
            var customer = {};
            customer.MPD_SAMPLE_ID = row.find("TD").eq(0).html();
            customer.MPD_SAMPLE_YN = row.find("TD").eq(1).html();
            
            customers.push(customer);
        });

        //Send the JSON array to Controller using AJAX.
        $.ajax({
            type: "POST",
            url: "/Procedure/InsertCustomers",
            data: JSON.stringify(customers),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (r) {
                alert(r + " record(s) inserted.");
            }
        });
    });
</script>
